{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "participants-router設定ファイル",
  "type": "object",
  "required": [
    "database",
    "experiments"
  ],
  "properties": {
    "base_path": {
      "type": "string",
      "description": "ベースパスの設定 (例: \"/~keimag/router\" や \"/router\") 空の場合は自動検知を試みます",
      "default": ""
    },
    "database": {
      "type": "object",
      "description": "データベース設定",
      "required": [
        "url"
      ],
      "properties": {
        "url": {
          "type": "string",
          "description": "データベースの接続先URL",
          "examples": [
            "mysql://user:password@localhost/dbname",
            "postgres://user:password@localhost/dbname",
            "sqlite//relative/path/to/dbfile",
            "sqlite///absolute/path/to/dbfile"
          ]
        },
        "table": {
          "type": "string",
          "description": "テーブル名(participants-routerが使うテーブルを変更したい場合)",
          "default": "participants_routes"
        }
      }
    },
    "experiments": {
      "type": "object",
      "description": "実験設定のコレクション。キーは実験ID。",
      "patternProperties": {
        "^.*$": {
          "type": "object",
          "description": "実験名(ID)",
          "required": [
            "enable",
            "config"
          ],
          "properties": {
            "enable": {
              "type": "boolean",
              "description": "この実験を有効にするかどうか (終了した実験はfalseに設定するとルーティングされません)"
            },
            "config": {
              "$ref": "#/definitions/ExperimentConfig"
            }
          }
        }
      }
    }
  },
  "definitions": {
    "ExperimentConfig": {
      "type": "object",
      "description": "ルーティングの基本設定",
      "required": [
        "access_control",
        "fallback_url",
        "groups"
      ],
      "properties": {
        "access_control": {
          "type": "object",
          "description": "アクセス制限設定 (Boolean Logic Tree)",
          "required": [
            "condition"
          ],
          "properties": {
            "condition": {
              "$ref": "#/definitions/BooleanCondition",
              "description": "評価する条件ツリー。trueなら参加許可、falseなら拒否。"
            },
            "deny_redirect": {
              "type": "string",
              "format": "uri",
              "description": "参加を拒否した場合のリダイレクト先URL"
            }
          }
        },
        "assignment_strategy": {
          "type": "string",
          "enum": [
            "minimum",
            "random"
          ],
          "default": "minimum",
          "description": "参加者の割り当て戦略 (minimum: 現時点で参加者が最も少ない条件に割り当てる, random: 現時点で空いている条件にランダムで割り当てる)"
        },
        "fallback_url": {
          "type": "string",
          "format": "uri",
          "description": "参加者が満員になった場合のフォールバック用URL"
        },
        "heartbeat_intervalsec": {
          "type": "integer",
          "description": "参加者を作業中とみなすHeartbeatの間隔(秒)。0にするとルーティング時に途中離脱を考慮しない。",
          "default": 60
        },
        "groups": {
          "type": "object",
          "description": "実験の条件定義",
          "patternProperties": {
            "^.*$": {
              "$ref": "#/definitions/Group",
              "description": "実験条件名(ID)"
            }
          }
        }
      }
    },
    "Group": {
      "type": "object",
      "required": [
        "limit",
        "steps"
      ],
      "properties": {
        "limit": {
          "type": "integer",
          "minimum": 1,
          "description": "参加人数制限"
        },
        "steps": {
          "type": "array",
          "description": "実験のステップ配列",
          "items": {
            "oneOf": [
              {
                "type": "string",
                "format": "uri",
                "description": "簡易記法: URL文字列のみ"
              },
              {
                "$ref": "#/definitions/StepObject"
              }
            ]
          }
        }
      }
    },
    "StepObject": {
      "type": "object",
      "description": "実験のステップ定義",
      "required": [
        "id",
        "url"
      ],
      "properties": {
        "id": {
          "type": "string",
          "description": "ステップID．遷移先指定などで使用。"
        },
        "url": {
          "type": "string",
          "format": "uri",
          "description": "ステップのURL"
        },
        "transitions": {
          "type": "array",
          "description": "条件分岐ルール",
          "items": {
            "$ref": "#/definitions/TransitionRule"
          }
        }
      }
    },
    "BooleanCondition": {
      "type": "object",
      "description": "再帰的な条件定義。all_of(AND), any_of(OR), not(NOT), または個別のルール(RuleBase)を指定します。",
      "oneOf": [
        {
          "properties": {
            "all_of": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/BooleanCondition"
              },
              "minItems": 1
            }
          },
          "required": [
            "all_of"
          ]
        },
        {
          "properties": {
            "any_of": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/BooleanCondition"
              },
              "minItems": 1
            }
          },
          "required": [
            "any_of"
          ]
        },
        {
          "properties": {
            "not": {
              "$ref": "#/definitions/BooleanCondition"
            }
          },
          "required": [
            "not"
          ]
        },
        {
          "$ref": "#/definitions/RuleBase"
        }
      ]
    },
    "RuleBase": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "regex",
            "fetch"
          ],
          "description": "ルールの種類"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "regex"
              }
            }
          },
          "then": {
            "required": [
              "field",
              "pattern"
            ],
            "properties": {
              "field": {
                "type": "string",
                "description": "リクエストボディのpropertiesオブジェクトのキー名"
              },
              "pattern": {
                "type": "string",
                "description": "正規表現パターン"
              },
              "negate": {
                "type": "boolean",
                "description": "trueにすると，「正規表現にマッチしない」場合にtrueを返す",
                "default": false
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "fetch"
              }
            }
          },
          "then": {
            "required": [
              "url"
            ],
            "properties": {
              "url": {
                "type": "string",
                "format": "uri",
                "description": "問い合わせ先APIのURL (プレースホルダ: ${browser_id}, ${properties.key})"
              },
              "method": {
                "type": "string",
                "description": "問い合わせ先APIのHTTPリクエストメソッド",
                "enum": [
                  "GET",
                  "POST"
                ],
                "default": "GET"
              },
              "headers": {
                "type": "object",
                "additionalProperties": {
                  "type": "string"
                },
                "description": "リクエストヘッダー (プレースホルダ: ${browser_id}, ${properties.key})"
              },
              "body": {
                "type": "object",
                "description": "POST時のリクエストボディ (GETの時は無視されます) (プレースホルダ: ${browser_id}, ${properties.key})"
              },
              "expected_status": {
                "type": "integer",
                "description": "成功とみなすHTTPステータスコード (指定がない場合はJSONのreturn値または200系で判定)"
              },
              "negate": {
                "type": "boolean",
                "description": "trueにすると，「APIの結果がfalse/エラー」の場合にtrueを返す",
                "default": false
              }
            }
          }
        }
      ]
    },
    "TransitionRule": {
      "description": "ステップ遷移ルール",
      "allOf": [
        {
          "$ref": "#/definitions/RuleBase"
        },
        {
          "type": "object",
          "required": [
            "goto"
          ],
          "properties": {
            "goto": {
              "type": "string",
              "description": "遷移先のステップID"
            }
          }
        }
      ]
    }
  }
}